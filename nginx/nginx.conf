# Let Nginx re-resolve Docker service DNS so scaling works (multiple IPs for same name)
resolver 127.0.0.11 ipv6=off valid=10s;

# Upstreams (service names from docker-compose)
upstream auth_service     { server auth-service:8000; }
upstream user_service     { server user-service:8000; }
upstream comment_service  { server comment-service:8000; }

# Load-balanced upstream for posts (ready for compose scaling)
upstream post_backends {
    zone post_zone 64k;                # shared LB state (optional but good)
    server post-service:8000 resolve;  # re-resolve service name via Docker DNS
    keepalive 64;                      # reuse upstream connections
}

server {
    listen 80;

    # Gateway health
    location = /health {
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    # Root info
    location = / {
        return 200 "MicroBlogg API Gateway";
        add_header Content-Type text/plain;
    }

    location = /auth      { proxy_pass http://auth_service/auth; }
    location = /users     { proxy_pass http://user_service/users; }
    location = /comments  { proxy_pass http://comment_service/comments; }
    location = /posts     { proxy_pass http://post_backends/posts; }

    location /auth/       { proxy_pass http://auth_service; }
    location /users/      { proxy_pass http://user_service; }
    location /comments/   { proxy_pass http://comment_service; }
    location /posts/      { proxy_pass http://post_backends; }

    # Common proxy headers
    proxy_set_header Host              $http_host;  # preserves :8080 on the client side
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port  $server_port;

    # Timeouts (dev-friendly)
    proxy_connect_timeout 5s;
    proxy_send_timeout    15s;
    proxy_read_timeout    15s;

    # Do not rewrite Location headers
    proxy_redirect off;

    # Allow JSON bodies comfortably
    client_max_body_size 2m;
}
