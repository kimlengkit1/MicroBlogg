upstream auth_service     { server auth-service:8000; }
upstream user_service     { server user-service:8000; }
upstream post_service     { server post-service:8000; }
upstream comment_service  { server comment-service:8000; }

server {
    listen 80;

    # Gateway health
    location = /health {
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    location = / {
        return 200 "MicroBlogg API Gateway";
        add_header Content-Type text/plain;
    }

    # These avoid 301/307 redirects and keep POST bodies intact.

    # /auth
    location = /auth {
        proxy_pass http://auth_service/auth;
    }
    # /users
    location = /users {
        proxy_pass http://user_service/users;
    }
    # /posts
    location = /posts {
        proxy_pass http://post_service/posts;
    }
    # /comments
    location = /comments {
        proxy_pass http://comment_service/comments;
    }

    location /auth/     { proxy_pass http://auth_service; }
    location /users/    { proxy_pass http://user_service; }
    location /posts/    { proxy_pass http://post_service; }
    location /comments/ { proxy_pass http://comment_service; }

    # Common proxy headers (applies to all locations in this server)
    proxy_set_header Host              $http_host;         # preserves :8080
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port  $server_port;

    # Timeouts during dev
    proxy_connect_timeout 5s;
    proxy_send_timeout    15s;
    proxy_read_timeout    15s;

    # Do not rewrite Location headers
    proxy_redirect off;

    # Allow JSON bodies comfortably
    client_max_body_size 2m;

}
